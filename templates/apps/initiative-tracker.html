<div class="initiative-tracker">
  <header class="tracker-header">
    <h2>Initiative Tracker</h2>
    {{#if isActive}}
    <div class="phase-indicator">
      <span class="phase-label">Phase:</span>
      <span class="phase-number">{{currentPhase}}</span>
    </div>
    {{/if}}
  </header>

  <div class="tracker-controls">
    <button class="add-combatant" title="Add Selected Tokens">
      <i class="fas fa-plus"></i> Add Combatants
    </button>

    {{#if @root.isGM}}
    <button class="add-npc" title="Add NPCs (GM Only)">
      <i class="fas fa-user-plus"></i> Add NPCs
    </button>
    {{/if}} {{#if hasActiveCombat}}
    <button class="roll-all-initiative" title="Roll Initiative for All">
      <i class="fas fa-dice"></i> Roll All
    </button>

    {{#if @root.isGM}}
    <button
      class="roll-npc-initiative"
      title="Roll Initiative for NPCs (GM Only)"
    >
      <i class="fas fa-dice"></i> Roll NPCs
    </button>
    <button class="manage-npcs" title="Manage All NPCs (GM Only)">
      <i class="fas fa-users-cog"></i> Manage NPCs
    </button>
    {{/if}} {{#unless isActive}}
    <button class="start-combat" title="Start Combat">
      <i class="fas fa-play"></i> Start Combat
    </button>
    {{/unless}} {{#if isActive}}
    <button class="next-turn" title="Next Turn">
      <i class="fas fa-step-forward"></i> Next Turn
    </button>
    <button class="next-phase" title="Next Phase">
      <i class="fas fa-forward"></i> Next Phase
    </button>
    {{/if}}

    <button class="reset-combat" title="Reset Combat">
      <i class="fas fa-stop"></i> Reset
    </button>
    {{/if}}
  </div>

  <div class="combatants-list">
    {{#if combatants}}
    <div class="combatant-header">
      <span class="name-col">Name</span>
      <span class="init-col">Initiative</span>
      <span class="dice-col">Dice</span>
      <span class="reaction-col">Reaction</span>
      <span class="actions-col">Actions</span>
    </div>

    {{#each combatants}}
    <div
      class="combatant {{#if isActive}}active{{/if}} {{#if isNPC}}npc{{else}}pc{{/if}}"
      data-combatant-id="{{id}}"
    >
      <div class="combatant-info">
        <img class="combatant-image" src="{{img}}" alt="{{name}}" />
        <span class="combatant-name">
          {{name}} {{#if isNPC}}
          <span class="npc-indicator" title="NPC">NPC</span>
          {{else}}
          <span class="pc-indicator" title="Player Character">PC</span>
          {{/if}}
        </span>
      </div>

      <div class="initiative-display">
        {{#if hasRolled}}
        <div class="current-initiative">
          <input
            type="number"
            class="edit-initiative"
            value="{{currentInit}}"
            data-combatant-id="{{id}}"
            min="0"
          />
          <span class="initiative-label"
            >{{#if isActiveInPhase}}(Acting){{else}}(Waiting){{/if}}</span
          >
        </div>
        {{#if actionPhases}}
        <div class="phase-breakdown">
          <span class="phases-label">Phases:</span>
          {{#each actionPhases}}
          <span
            class="phase-init {{#if (eq this ../../currentInit)}}current{{/if}}"
            >{{this}}</span
          >
          {{/each}}
        </div>
        {{/if}} {{else}}
        <span class="not-rolled">â€”</span>
        {{/if}}
      </div>

      <div class="dice-display">
        <span class="dice-count">{{initiativeDice}}d6</span>
      </div>

      <div class="reaction-display">
        <span class="reaction-value">{{reaction}}</span>
      </div>

      <div class="combatant-actions">
        {{#unless hasRolled}}
        <button
          class="roll-initiative"
          data-combatant-id="{{id}}"
          title="Roll Initiative"
        >
          <i class="fas fa-dice"></i>
        </button>
        {{/unless}} {{#if isNPC}} {{#if @root.isGM}}
        <button
          class="modify-npc"
          data-combatant-id="{{id}}"
          title="Modify NPC (GM Only)"
        >
          <i class="fas fa-edit"></i>
        </button>
        {{/if}} {{/if}}
        <button
          class="remove-combatant"
          data-combatant-id="{{id}}"
          title="{{#if isNPC}}Remove NPC{{else}}Remove from Tracker{{/if}}"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    {{/each}} {{else}}
    <div class="empty-tracker">
      <p>No combatants in tracker.</p>
      <p>Select tokens and click "Add Combatants" to begin.</p>
    </div>
    {{/if}}
  </div>

  {{#if isActive}}
  <div class="turn-summary">
    <h3>Phase {{currentPhase}} - Current Turn</h3>
    {{#if activeCombatants}} {{#with (lookup activeCombatants ../currentTurn)}}
    <div class="current-actor">
      <img src="{{img}}" alt="{{name}}" />
      <div class="actor-details">
        <span class="actor-name">{{name}}</span>
        <span class="actor-initiative">Initiative: {{currentInit}}</span>
      </div>
    </div>
    {{else}}
    <div class="no-current-actor">
      <p>No active combatants in Phase {{../currentPhase}}</p>
    </div>
    {{/with}} {{else}}
    <div class="no-current-actor">
      <p>No active combatants in Phase {{currentPhase}}</p>
    </div>
    {{/if}}
  </div>
  {{/if}}
</div>
